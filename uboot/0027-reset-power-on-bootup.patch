From 652238cd51e3ef89d3e29f2b2e42ec463b9512e9 Mon Sep 17 00:00:00 2001
From: Lu Hui <luhui@sipeed.com>
Date: Tue, 5 Dec 2023 16:32:54 +0800
Subject: [PATCH 27/27] reset power on bootup

---
 arch/riscv/dts/light-lpi4a-laptop.dts |  6 ++++--
 drivers/video/ilitek-ili9881c.c       | 18 ++++++++++++++++--
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/arch/riscv/dts/light-lpi4a-laptop.dts b/arch/riscv/dts/light-lpi4a-laptop.dts
index 45deb1a9..27af382d 100644
--- a/arch/riscv/dts/light-lpi4a-laptop.dts
+++ b/arch/riscv/dts/light-lpi4a-laptop.dts
@@ -35,9 +35,11 @@
 };
 
 &panel0 {
-	status = "disabled";
+	status = "okay";
 	backlight       = <&lcd_backlight>;
-	reset-gpios     = <&pcal6408ahk_d 7 0>; /* active low  */
+	// 5v power cycle
+	// TODO: move into regulator
+	reset-gpios     = <&pcal6408ahk_c 0 0>; /* active low  */
 	/delete-property/ lcd-en-gpios;
 	/delete-property/ lcd-bias-en-gpios;
 };
diff --git a/drivers/video/ilitek-ili9881c.c b/drivers/video/ilitek-ili9881c.c
index 84c0dcd6..61ba4bae 100644
--- a/drivers/video/ilitek-ili9881c.c
+++ b/drivers/video/ilitek-ili9881c.c
@@ -368,12 +368,12 @@ static int ili9881c_panel_prepare(struct udevice *panel)
 	ret = dm_gpio_set_value(&priv->reset, true);
 	if (ret)
 		return ret;
-	mdelay(1);
+	mdelay(500);
 
 	ret = dm_gpio_set_value(&priv->reset, false);
 	if (ret)
 		return ret;
-	mdelay(10);
+	mdelay(100);
 
 	return 0;
 }
@@ -464,6 +464,20 @@ static int ili9881c_panel_ofdata_to_platdata(struct udevice *dev)
 		dev_err(dev, "Warning: cannot get reset GPIO\n");
 		if (ret != -ENOENT)
 			return ret;
+	} else {
+		/* not a bug, but uboot's regulator is buggy,
+		I haven't more time to fix it, so put it here
+		*/
+		/* reset panel */
+		ret = dm_gpio_set_value(&priv->reset, false);
+		if (ret)
+			return ret;
+		mdelay(100);
+
+		ret = dm_gpio_set_value(&priv->reset, true);
+		if (ret)
+			return ret;
+		mdelay(100);
 	}
 
 	/* power gpios */
-- 
2.34.1

